我将为您详细介绍如何使用Postman全面测试WebSocket功能，包括私聊、群聊、广播、心跳、消息传输、离线消息缓存、文件传输等功能。

## 使用Postman全面测试WebSocket功能

### 1. 建立WebSocket连接

1. 打开Postman
2. 点击左上角的"New" -> "WebSocket Request"
3. 在URL栏输入WebSocket连接地址：
   ```
   ws://localhost:8084/ws
   ```

4. 点击"Headers"选项卡，添加请求头：
   - Key: `X-User-Id`
   - Value: 用户ID（例如：`user1`、`user2`等）
5. 点击"Connect"建立连接

连接成功后，您将收到欢迎消息和在线用户列表。

### 2. 私聊消息测试

#### 发送文本私聊消息
```json
{
  "type": "text",
  "content": "这是一条私聊消息",
  "receiverId": "user2"
}
```

### 3. 群聊消息测试

#### 发送文本群聊消息
```json
{
  "type": "text",
  "content": "这是一条群聊消息",
  "groupId": "group1"
}
```

### 4. 广播消息测试

#### 发送文本广播消息
```json
{
  "type": "text",
  "content": "这是一条广播消息"
}
```

#### 发送心跳消息
```json
{
  "content": "ping"
}
```

服务器会回复：
```json
{
  "type": "pong",
  "content": "pong",
  "timestamp": 1634567890123
}
```

### 5. 离线消息测试

#### 测试步骤：

1. 使用用户A（例如user1）连接WebSocket
2. 使用用户B（例如user2）连接WebSocket
3. 断开用户B的连接（关闭Postman标签页或点击Disconnect）
4. 使用用户A向用户B发送几条消息：
   ```json
   {
     "type": "text",
     "content": "这是离线消息1",
     "receiverId": "user2"
   }
   ```

5. 重新使用用户B连接WebSocket
6. 用户B将自动收到之前发送的离线消息，消息类型会带有`offline_`前缀：
   ```json
   {
     "type": "offline_text",
     "content": "这是离线消息1",
     "senderId": "user1",
     "receiverId": "user2",
     "timestamp": 1634567890123
   }
   ```

### 6. 多用户测试

#### 用户1连接
1. 新建WebSocket连接
2. URL: `ws://localhost:8084/ws`
3. Headers: `X-User-Id: user1`

#### 用户2连接
1. 新建WebSocket连接（可以使用Postman的新标签页）
2. URL: `ws://localhost:8084/ws`
3. Headers: `X-User-Id: user2`

#### 用户3连接
1. 新建WebSocket连接（可以使用Postman的新标签页）
2. URL: `ws://localhost:8084/ws`
3. Headers: `X-User-Id: user3`

#### 用户之间发送消息
在用户1的连接中发送私聊消息：
```json
{
  "type": "text",
  "content": "你好，user2",
  "receiverId": "user2"
}
```

在用户1的连接中发送群聊消息：
```json
{
  "type": "text",
  "content": "大家好",
  "groupId": "group1"
}
```

在用户1的连接中发送广播消息：
```json
{
  "type": "text",
  "content": "这是广播消息"
}
```

### 7. 文件传输功能

系统现在统一使用文件上传方式传输文件，避免了Base64编码带来的数据膨胀问题。

#### 文件上传接口

使用HTTP POST方法上传文件到 `/file/upload` 接口：

```
POST /file/upload
Content-Type: multipart/form-data

file: [文件数据]
senderId: [发送者ID，必填]
receiverId: [接收者ID，私聊时使用]
groupId: [群组ID，群聊时使用]
fileType: [文件类型，如image、voice等]
content: [消息内容]
```

上传成功后，服务器会：
1. 保存文件到本地
2. 自动通过WebSocket发送包含文件URL的消息给指定用户或群组
3. 返回如下格式的响应：

```json
{
  "success": true,
  "filename": "唯一文件名",
  "originalFilename": "原始文件名",
  "size": "文件大小",
  "url": "/file/download/唯一文件名"
}
```

#### 文件类型支持

系统支持多种文件类型，您可以通过设置[fileType](file://C:\Users\yztzy\IdeaProjects\arithmetic\studyParty\studyParty_websocket\src\main\java\com\studyParty\websocket\model\WebSocketMessage.java#L35-L35)字段来标识：

- image：图片文件（jpg, png, gif等）
- `voice`：音频文件（mp3, wav, ogg等）
- `video`：视频文件（mp4, avi, mov等）
- document：文档文件（pdf, doc, xls等）
- 其他自定义类型

#### 接收文件消息

当您接收到文件消息时，根据[type](file://C:\Users\yztzy\IdeaProjects\arithmetic\studyParty\studyParty_websocket\src\main\java\com\studyParty\websocket\model\WebSocketMessage.java#L13-L13)字段区分消息类型：

- `image_private`：私聊图片消息
- `voice_private`：私聊音频消息
- `video_private`：私聊视频消息
- `document_private`：私聊文档消息

- `image_group`：群聊图片消息
- `voice_group`：群聊音频消息
- `video_group`：群聊视频消息
- `document_group`：群聊文档消息

- `image_public`：广播图片消息
- `voice_public`：广播音频消息
- `video_public`：广播视频消息
- `document_public`：广播文档消息

- `offline_image`：离线图片消息
- `offline_voice`：离线音频消息
- `offline_video`：离线视频消息
- `offline_document`：离线文档消息

#### 文件下载

接收方收到文件消息后，可以通过[fileUrl](file://C:\Users\yztzy\IdeaProjects\arithmetic\studyParty\studyParty_websocket\src\main\java\com\studyParty\websocket\model\WebSocketMessage.java#L26-L26)字段下载文件。

### 8. 自动发送文件消息功能

当通过文件上传接口上传文件时，如果提供了`senderId`参数，系统会自动将文件消息发送给指定的用户或群组，无需手动发送WebSocket消息。

参数说明：
- `file`: 必填，要上传的文件
- `senderId`: 必填，发送者ID
- `receiverId`: 可选，私聊时的目标用户ID
- `groupId`: 可选，群聊时的群组ID
- `fileType`: 可选，文件类型（如image、voice、video、document）
- `content`: 可选，消息内容

这种方式特别适用于聊天过程中上传文件的场景，用户只需上传文件，系统会自动将文件消息发送给聊天对象。

### 9. 大文件支持

对于超过64KB的文件，系统支持通过文件上传接口上传文件，然后通过WebSocket传输文件URL的方式进行传输。这种方式可以支持任意大小的文件传输，突破了WebSocket帧大小的限制。